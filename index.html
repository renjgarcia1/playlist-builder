<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Playlist Builder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="dist/sp-bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<!-- NAVBAR -->
<div class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="index.html">
        <strong>Playlist Builder</strong>
      </a>
    </div>
    <a href="https://www.spotify.com" class="btn btn-primary navbar-btn navbar-right">
      Get Spotify
    </a>
  </div>
</div>

<!-- HERO -->
<div id="top" class="jumbotron">
  <div class="container-fluid text-center">
    <h1>Playlist Builder</h1>
    <p class="lead">Build smarter Spotify playlists from real listener data.</p>

    <p id="ttext">
      Playlist Builder scans thousands of public Spotify playlists
      and identifies the most frequently used tracks based on your search.
    </p>

    <!-- LOGIN -->
    <div id="login-form">
      <p>Log in with Spotify to begin.</p>
      <button class="btn btn-success btn-lg" id="login-button">Login with Spotify</button>
    </div>

    <!-- SEARCH -->
    <div id="search-form" class="row" style="display:none;">
      <div class="col-xs-10 col-xs-offset-1 col-sm-6 col-sm-offset-3">
        <input id="playlist-terms" class="form-control input-lg"
               placeholder="workout, party, latin, hip hop">
        <br>
        <button id="go" class="btn btn-primary btn-lg">Find Playlists</button>
      </div>
    </div>
  </div>
</div>

<!-- RESULTS -->
<div class="container-fluid work" style="display:none;" id="results-section">
  <div id="info" class="h4 text-center"></div>

  <div class="results" id="playlist-table">
    <h2>Matching Playlists for <span class="keywords"></span></h2>
    <div class="progress">
      <div id="playlist-progress" class="progress-bar" style="width:0%"></div>
    </div>
    <p>
      Found <strong><span class="total-playlists">0</span></strong> playlists
      with <strong><span class="total-tracks">0</span></strong> total tracks.
    </p>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>#</th>
          <th>Playlist</th>
          <th>Tracks</th>
        </tr>
      </thead>
      <tbody id="playlist-items"></tbody>
    </table>
  </div>

  <div class="results" id="track-table">
    <h2>Top Tracks</h2>
    <div id="ready-to-save" style="display:none;">
      <button id="save-button" class="btn btn-success btn-lg">Save Playlist to Spotify</button>
    </div>
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>#</th>
          <th>Track</th>
          <th>Artist</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody id="track-items"></tbody>
    </table>
  </div>
</div>

<footer class="text-center">
  <p class="text-muted">Playlist Builder Â· Powered by Spotify</p>
</footer>

<!-- LIBS -->
<script src="lib/jquery-1.11.1.min.js"></script>
<script src="lib/bootstrap.min.js"></script>
<script src="lib/underscore-min.js"></script>

<script>
/* =====================================
   SPOTIFY PKCE CONFIG
===================================== */
const CLIENT_ID = "d36e30807e5c4cd68c64b3d30789bc8a";
const REDIRECT_URI = https://renjgarcia1.github.io/playlist-builder/

const SCOPES = "playlist-modify-public playlist-read-private";

/* PKCE HELPERS */
function generateRandomString(length) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  return Array.from(crypto.getRandomValues(new Uint8Array(length)))
    .map(x => chars[x % chars.length]).join("");
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  return crypto.subtle.digest("SHA-256", encoder.encode(plain));
}

function base64urlencode(buffer) {
  return btoa(String.fromCharCode(...new Uint8Array(buffer)))
    .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function generateCodeChallenge(verifier) {
  const hashed = await sha256(verifier);
  return base64urlencode(hashed);
}

/* LOGIN WITH SPOTIFY */
async function loginWithSpotify() {
  const verifier = generateRandomString(64);
  const challenge = await generateCodeChallenge(verifier);
  localStorage.setItem("pkce_verifier", verifier);

  const authUrl =
    "https://accounts.spotify.com/authorize" +
    "?client_id=" + CLIENT_ID +
    "&response_type=code" +
    "&redirect_uri=" + encodeURIComponent(REDIRECT_URI) +
    "&scope=" + encodeURIComponent(SCOPES) +
    "&code_challenge_method=S256" +
    "&code_challenge=" + challenge;

  window.location.href = authUrl;
}

/* HANDLE SPOTIFY CALLBACK */
async function handleSpotifyCallback() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  if (!code) return;

  const verifier = localStorage.getItem("pkce_verifier");

  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      client_id: CLIENT_ID,
      grant_type: "authorization_code",
      code: code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    })
  });

  const data = await response.json();
  if (data.access_token) {
    localStorage.setItem("spotify_access_token", data.access_token);
    window.history.replaceState({}, document.title, "/");
    showApp();
  }
}

/* UI CONTROL */
function showApp() {
  document.getElementById("login-form").style.display = "none";
  document.getElementById("search-form").style.display = "block";
  document.getElementById("results-section").style.display = "block";
}

/* SEARCH PLAYLISTS */
async function searchPlaylists(keyword) {
  const token = localStorage.getItem("spotify_access_token");
  const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(keyword)}&type=playlist&limit=10`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  return data.playlists.items;
}

/* GET TRACKS FROM PLAYLIST */
async function getTracksFromPlaylist(id) {
  const token = localStorage.getItem("spotify_access_token");
  const res = await fetch(`https://api.spotify.com/v1/playlists/${id}/tracks?limit=50`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  return data.items.map(item => item.track);
}

/* BUILD TOP TRACKS */
async function buildTopTracks() {
  const keyword = document.getElementById("playlist-terms").value;
  const playlists = await searchPlaylists(keyword);

  document.getElementById("playlist-items").innerHTML = "";
  playlists.forEach((pl, i) => {
    document.getElementById("playlist-items").innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${pl.name}</td>
        <td>${pl.tracks.total}</td>
      </tr>`;
  });

  let trackCount = {};
  for (const pl of playlists) {
    const tracks = await getTracksFromPlaylist(pl.id);
    tracks.forEach(t => {
      if (!t) return;
      const key = `${t.name} - ${t.artists[0].name}`;
      trackCount[key] = (trackCount[key] || 0) + 1;
    });
  }

  // Sort tracks by count
  const sortedTracks = Object.entries(trackCount)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 20);

  document.getElementById("track-items").innerHTML = "";
  sortedTracks.forEach(([name, count], i) => {
    const [trackName, artist] = name.split(" - ");
    document.getElementById("track-items").innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${trackName}</td>
        <td>${artist}</td>
        <td>${count}</td>
      </tr>`;
  });

  document.getElementById("ready-to-save").style.display = "block";
}

/* SAVE NEW PLAYLIST */
async function savePlaylist() {
  const token = localStorage.getItem("spotify_access_token");
  const profileRes = await fetch("https://api.spotify.com/v1/me", {
    headers: { Authorization: `Bearer ${token}` }
  });
  const profile = await profileRes.json();

  const playlistRes = await fetch(`https://api.spotify.com/v1/users/${profile.id}/playlists`, {
    method: "POST",
    headers: { 
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ name: "Top Tracks Playlist", public: true })
  });

  const playlist = await playlistRes.json();

  const tracks = Array.from(document.querySelectorAll("#track-items tr td:nth-child(2)")).map(td => td.textContent);
  const uris = tracks.map(t => `spotify:track:${t}`); // Simplified; real implementation would require track IDs

  alert("Playlist created! Track saving requires track IDs (simplified here).");
}

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("spotify_access_token");
  if (token) showApp();

  document.getElementById("login-button").addEventListener("click", loginWithSpotify);
  document.getElementById("go").addEventListener("click", buildTopTracks);
  document.getElementById("save-button").addEventListener("click", savePlaylist);

  handleSpotifyCallback();
});
</script>

</body>
</html>
