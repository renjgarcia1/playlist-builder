<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playlist Builder</title>
    <link rel="stylesheet" href="dist/sp-bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        body { padding-top: 70px; }
        #token-status { font-weight: bold; margin-top: 10px; }
        .results { margin-top: 20px; }
        #track-table { display: none; }
        #search-form { display: none; }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Playlist Builder</a>
    </div>
    <a href="https://www.spotify.com" class="btn btn-primary navbar-btn navbar-right">
      Get Spotify
    </a>
  </div>
</nav>

<!-- HERO / LOGIN -->
<div class="jumbotron text-center">
    <div class="container">
        <h1>Playlist Builder</h1>
        <p class="lead">Build smarter Spotify playlists from real listener data.</p>

        <div id="login-form">
            <p>Log in with Spotify to begin.</p>
            <button class="btn btn-success btn-lg" id="login-button">Login with Spotify</button>
            <div id="token-status"></div>
        </div>

        <div id="search-form">
            <input type="text" id="playlist-terms" class="form-control input-lg" placeholder="workout, party, latin, hip hop">
            <br>
            <button id="go" class="btn btn-primary btn-lg">Find Playlists</button>
        </div>
    </div>
</div>

<!-- RESULTS -->
<div class="container results" id="playlist-section">
    <h2>Matching Playlists for <span class="keywords"></span></h2>
    <p>Found <strong><span class="total-playlists">0</span></strong> playlists with <strong><span class="total-tracks">0</span></strong> tracks.</p>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Playlist</th>
                <th>Tracks</th>
            </tr>
        </thead>
        <tbody id="playlist-items"></tbody>
    </table>
    <button id="fetch-tracks" class="btn btn-primary">Find Top Tracks</button>
</div>

<div class="container results" id="track-table">
    <h2>Top Tracks</h2>
    <button id="save-button" class="btn btn-success">Save Playlist to Spotify</button>
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Track</th>
                <th>Artist</th>
                <th>Count</th>
            </tr>
        </thead>
        <tbody id="track-items"></tbody>
    </table>
</div>

<footer class="text-center">
    <p class="text-muted">Playlist Builder · Powered by Spotify</p>
</footer>

<!-- LIBS -->
<script src="lib/jquery-1.11.1.min.js"></script>
<script src="lib/bootstrap.min.js"></script>
<script src="lib/underscore-min.js"></script>

<script>
const CLIENT_ID = "d36e30807e5c4cd68c64b3d30789bc8a";
const REDIRECT_URI = "https://renjgarcia1.github.io/playlist-builder/";
const SCOPES = "playlist-modify-public playlist-read-private";

let token = null;

/* LOGIN / TOKEN */
function loginWithSpotify() {
    const authUrl = 
        "https://accounts.spotify.com/authorize?" +
        "client_id=" + encodeURIComponent(CLIENT_ID) +
        "&response_type=token" +
        "&scope=" + encodeURIComponent(SCOPES) +
        "&redirect_uri=" + encodeURIComponent(REDIRECT_URI);
    window.location.href = authUrl;
}

function parseTokenFromHash() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const access_token = params.get("access_token");
    if (access_token) {
        token = access_token;
        localStorage.setItem("spotify_access_token", token);
        window.location.hash = "";
    }
    return token;
}

function updateTokenStatus() {
    const statusEl = document.getElementById("token-status");
    token = token || localStorage.getItem("spotify_access_token");
    if (token) {
        statusEl.textContent = "Token exists ✅";
        statusEl.style.color = "green";
        document.getElementById("login-form").style.display = "none";
        document.getElementById("search-form").style.display = "block";
    } else {
        statusEl.textContent = "No token ❌";
        statusEl.style.color = "red";
        document.getElementById("login-form").style.display = "block";
    }
}

/* SEARCH PLAYLISTS */
async function searchPlaylists(keyword) {
    const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(keyword)}&type=playlist&limit=10`, {
        headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    return data.playlists.items;
}

/* GET TRACKS FROM PLAYLIST */
async function getTracksFromPlaylist(id) {
    const res = await fetch(`https://api.spotify.com/v1/playlists/${id}/tracks?limit=50`, {
        headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    return data.items.map(item => item.track);
}

/* BUILD TOP TRACKS */
async function buildTopTracks() {
    const keyword = document.getElementById("playlist-terms").value;
    const playlists = await searchPlaylists(keyword);

    document.getElementById("playlist-items").innerHTML = "";
    playlists.forEach((pl, i) => {
        document.getElementById("playlist-items").innerHTML += `
            <tr>
                <td>${i+1}</td>
                <td>${pl.name}</td>
                <td>${pl.tracks.total}</td>
            </tr>`;
    });

    let trackCount = {};
    for (const pl of playlists) {
        const tracks = await getTracksFromPlaylist(pl.id);
        tracks.forEach(t => {
            if (!t) return;
            const key = `${t.name} - ${t.artists[0].name}`;
            trackCount[key] = (trackCount[key] || 0) + 1;
        });
    }

    const sortedTracks = Object.entries(trackCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 20);

    document.getElementById("track-items").innerHTML = "";
    sortedTracks.forEach(([name, count], i) => {
        const [trackName, artist] = name.split(" - ");
        document.getElementById("track-items").innerHTML += `
            <tr>
                <td>${i+1}</td>
                <td>${trackName}</td>
                <td>${artist}</td>
                <td>${count}</td>
            </tr>`;
    });

    document.getElementById("track-table").style.display = "block";
}

/* SAVE PLAYLIST */
async function savePlaylist() {
    const profileRes = await fetch("https://api.spotify.com/v1/me", {
        headers: { Authorization: `Bearer ${token}` }
    });
    const profile = await profileRes.json();

    const playlistRes = await fetch(`https://api.spotify.com/v1/users/${profile.id}/playlists`, {
        method: "POST",
        headers: { 
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ name: "Top Tracks Playlist", public: true })
    });

    const playlist = await playlistRes.json();
    alert("Playlist created! Adding tracks requires track IDs (simplified).");
}

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
    parseTokenFromHash();
    updateTokenStatus();

    document.getElementById("login-button").addEventListener("click", loginWithSpotify);
    document.getElementById("go").addEventListener("click", buildTopTracks);
    document.getElementById("save-button").addEventListener("click", savePlaylist);
});
</script>
</body>
</html>
