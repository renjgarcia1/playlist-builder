<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Playlist Builder</title>

    <link type="text/css" href="styles.css" rel="stylesheet" />
    <link href="dist/sp-bootstrap.min.css" rel="stylesheet">

</head>
<body>

<div class="navbar navbar-default">
  <div class="container">
    <a class="navbar-brand" href="#">Playlist Builder</a>
  </div>
</div>

<div class="jumbotron text-center">
  <h1>Playlist Builder</h1>
  <p>The best DJ is everybody.</p>
  <button class="btn btn-primary btn-lg" onclick="loginWithSpotify()">
    Login with Spotify
  </button>
</div>

<script src="lib/jquery-1.11.1.min.js"></script>
<script src="lib/bootstrap.min.js"></script>
<script src="lib/underscore-min.js"></script>

<script>
"use strict";

/* ========= PKCE HELPERS ========= */

function generateRandomString(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

async function generateCodeChallenge(codeVerifier) {
  const data = new TextEncoder().encode(codeVerifier);
  const digest = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(digest)))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=+$/, '');
}

/* ========= SPOTIFY LOGIN ========= */

async function loginWithSpotify() {
  const client_id = 'd36e30807e5c4cd68c64b3d30789bc8a';
  const redirect_uri = 'https://renjgarcia1.github.io/playlist-builder/';
  const scopes = 'playlist-modify-public';

  const codeVerifier = generateRandomString(128);
  localStorage.setItem('spotify_code_verifier', codeVerifier);

  const codeChallenge = await generateCodeChallenge(codeVerifier);

  const authUrl =
    'https://accounts.spotify.com/authorize?' +
    'response_type=code' +
    '&client_id=' + client_id +
    '&scope=' + encodeURIComponent(scopes) +
    '&redirect_uri=' + encodeURIComponent(redirect_uri) +
    '&code_challenge_method=S256' +
    '&code_challenge=' + codeChallenge;

  window.location.href = authUrl;
}

/* ========= HANDLE REDIRECT ========= */

async function handleRedirect() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');

  if (!code) return;

  const codeVerifier = localStorage.getItem('spotify_code_verifier');

  const body = new URLSearchParams({
    grant_type: 'authorization_code',
    code: code,
    redirect_uri: 'https://renjgarcia1.github.io/playlist-builder/',
    client_id: 'd36e30807e5c4cd68c64b3d30789bc8a',
    code_verifier: codeVerifier
  });

  const response = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: body
  });

  const data = await response.json();
  console.log('Spotify token response:', data);

  // Store token
  localStorage.setItem('spotify_access_token', data.access_token);

  // Clean URL
  window.history.replaceState({}, document.title, "/playlist-builder/");
}

handleRedirect();

</script>

</body>
</html>
